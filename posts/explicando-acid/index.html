<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Explicando o A.C.I.D. com testes - Alen Vieira</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta itemprop=name content="Explicando o A.C.I.D. com testes"><meta itemprop=description content="Quais são as garantias do A.C.I.D.?"><meta itemprop=datePublished content="2024-04-15T12:18:29-03:00"><meta itemprop=dateModified content="2024-04-15T12:18:29-03:00"><meta itemprop=wordCount content="1807"><meta itemprop=keywords content><meta property="og:title" content="Explicando o A.C.I.D. com testes"><meta property="og:description" content="Quais são as garantias do A.C.I.D.?"><meta property="og:type" content="article"><meta property="og:url" content="https://alenvieira.github.io/posts/explicando-acid/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-15T12:18:29-03:00"><meta property="article:modified_time" content="2024-04-15T12:18:29-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Explicando o A.C.I.D. com testes"><meta name=twitter:description content="Quais são as garantias do A.C.I.D.?"><link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=https://alenvieira.github.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://alenvieira.github.io/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=https://alenvieira.github.io/css/dark.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://alenvieira.github.io/js/main.js></script></head><body><div class="container wrapper"><div class=header><h1 class=site-title><a href=https://alenvieira.github.io/>Alen Vieira</a></h1><div class=site-description><p>Compartilhando ou documentando aprendizados</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/alenvieira title=Github><i data-feather=github></i></a></li><li><a href=https://twitter.com/alen_vieira title=Twitter><i data-feather=twitter></i></a></li><li><a href=../../index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=../../>Home</a></li><li><a href=../../posts>Posts</a></li><li><a href=../../about>Sobre</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>15</span>
<span class=rest>Apr 2024</span></div></div><div class=matter><h1 class=title>Explicando o A.C.I.D. com testes</h1></div></div><div class=markdown><blockquote><p>Os dados são preciosos e duram mais que os próprios sistemas. Tim Berners-Lee</p></blockquote><p>O A.C.I.D. é uma sopa de letrinhas onde cada letra corresponde uma garantia para transações em diferentes bancos de dados. No entanto, essas propriedades são geralmente explicadas de forma teórica e nem sempre são demonstradas na prática com código. Eu prefiro ver como os conceitos funcionam através de testes, pois isso me ajuda a entendê-los melhor.</p><p>Os testes foram realizados com a linguagem de programação <a href=https://www.python.org/>Python</a> e o banco de dados relacional <a href=https://www.postgresql.org/>PostgreSQL</a>. Utilizamos a biblioteca Python <a href=https://testcontainers-python.readthedocs.io/en/latest/>testcontainers-python</a> para rodar o PostgreSQL em um container e a biblioteca Python <a href=https://www.psycopg.org/psycopg3/>Psycopg 3</a> para conectar-se ao PostgreSQL e executar comandos. Mais detalhes estão disponíveis neste <a href=https://github.com/alenvieira/acidwithtests/>repositório</a>, onde você pode ver que os <a href=https://github.com/alenvieira/acidwithtests/actions/runs/8672804316/job/23783502175>testes foram executados</a> com sucesso no GitHub Actions, comprovando que funcionam fora da minha máquina. :D</p><p>Um detalhe muito importante a observar é o uso do contexto de conexão no Psycopg 3. Quando você cria uma conexão usando o <strong>with</strong>, o comportamento é o seguinte:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green># Fonte: https://www.psycopg.org/psycopg3/docs/basic/usage.html#connection-context</span>
</span></span><span style=display:flex><span>conn = psycopg.connect()
</span></span><span style=display:flex><span><span style=color:#00f>try</span>:
</span></span><span style=display:flex><span>    ... <span style=color:green># use the connection</span>
</span></span><span style=display:flex><span><span style=color:#00f>except</span> BaseException:
</span></span><span style=display:flex><span>    conn.rollback()
</span></span><span style=display:flex><span><span style=color:#00f>else</span>:
</span></span><span style=display:flex><span>    conn.commit()
</span></span><span style=display:flex><span><span style=color:#00f>finally</span>:
</span></span><span style=display:flex><span>    conn.close()
</span></span></code></pre></div><p>Ou seja, se todas as operações na conexão forem bem-sucedidas, elas serão confirmadas (commit). Caso contrário, todas serão revertidas (rollback). Em ambos os casos, a conexão será encerrada automaticamente.</p><p>Para preparar o ambiente dos testes unitários, implementei o seguinte:</p><ul><li>o método setUpClass que inicia o PostgreSQL e cria uma tabela antes da execução dos testes;</li><li>o método tearDownClass para parar o PostgreSQL após todos os testes;</li><li>o método connection_uri permite obter facilmente um URI do Postgresql e usá-lo para criar uma conexão;</li><li>o método tearDown que realiza a limpeza da tabela após cada teste.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>class</span> <span style=color:#2b91af>AcidWithPostgresTestCase</span>(unittest.TestCase):
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> setUpClass(cls):
</span></span><span style=display:flex><span>        cls.postgres = PostgresContainer(<span style=color:#a31515>&#34;postgres:16.2-alpine&#34;</span>)
</span></span><span style=display:flex><span>        cls.postgres.start()
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(cls.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;CREATE TABLE employee (id serial PRIMARY KEY, name text, salary double precision)&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> tearDownClass(cls):
</span></span><span style=display:flex><span>        cls.postgres.stop()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> connection_uri(cls):
</span></span><span style=display:flex><span>        <span style=color:#00f>return</span> cls.postgres.get_connection_url().replace(<span style=color:#a31515>&#34;+psycopg2&#34;</span>, <span style=color:#a31515>&#34;&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> tearDown(self):
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;DELETE FROM employee&#34;</span>)
</span></span></code></pre></div><p>Todos os conceitos apresentados referem-se a transações. Mas o que é uma transação? Uma transação é um processo que envolve uma ou mais operações de leitura e gravação, geralmente associadas a uma regra de negócio. Agora, vamos testar cada uma das propriedades do acrônimo:</p><p>O A de Atomicity(Atomicidade) é a propriedade responsável por gerenciar as transações. As transações são indivisíveis/atômicas, devem confirmar tudo com um commit ou desfazer tudo com um rollback.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> test_atomicity(self):
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;John Smith&#34;</span>, 2500))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> self.assertRaises(Exception):
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Beth Lee&#34;</span>, 3500))
</span></span><span style=display:flex><span>                <span style=color:#00f>raise</span> RuntimeError
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;SELECT name, salary FROM employee&#34;</span>)
</span></span><span style=display:flex><span>            db_data = cur.fetchall()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    self.assertEqual(len(db_data), 1)
</span></span><span style=display:flex><span>    self.assertEqual(db_data[0], (<span style=color:#a31515>&#34;John Smith&#34;</span>, 2500))
</span></span></code></pre></div><p>No teste de atomicidade acima, a primeira parte realiza uma transação para adicionar o funcionário John Smith. A segunda parte tenta adicionar a funcionária Beth Lee, mas uma exceção ocorre imediatamente após, que pode ser causada por diversos problemas, como um tipo de dado incorreto para o salário ou uma regra de negócio inválida. Para simplificar, neste exemplo, a exceção é uma RuntimeError. A terceira parte do teste verifica quais funcionários foram realmente salvos na base de dados.</p><p>Na parte final, a primeira afirmação pode causar confusão, pois só um registro foi salvo no banco. Vamos esclarecer: na primeira etapa, o registro de John foi salvo com sucesso, totalizando um registro. Na segunda etapa, apesar de Beth ter sido salva corretamente, uma exceção fez com que toda a transação fosse revertida. Portanto, apenas o registro de John permaneceu. Os testes confirmaram que as transações são indivisíveis, prevenindo a introdução de dados inconsistentes.</p><p>Porém, entretanto, todavia, é crucial avaliar quais operações realmente precisam estar agrupadas em uma transação. Por exemplo, uma transferência de valores entre duas contas — de X para Y — deve ser tratada como uma única transação, pois envolve a alteração dos valores de ambas as contas. Neste caso, garantir que ambas as operações (débito e crédito) ocorram juntas é essencial para manter a consistência.</p><p>Por outro lado, a inserção de funcionários no sistema pode não ser o melhor exemplo de uma transação indivisível, visto que cada cadastro de funcionário pode ser independente. Portanto, ao projetar suas transações, é importante analisar cuidadosamente seu cenário e determinar quais operações podem ser agrupadas.</p><p>O C de Consistency(Consistência) é uma propriedade associada às regras de integridade definidas. Cada transação sempre deixa o estado consistente. Isso significa que todas as regras de integridade são aplicadas como validações de existência da coluna, de tipo de dado da coluna, de chave primária, de chave estrangeira, de unicidade da coluna e outras restrições que o banco de dados suporte.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> test_consistency(self):
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Dep Tunner&#34;</span>, 3000))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> self.assertRaises(Exception):
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Mary Castle&#34;</span>, datetime.date(2024, 12, 20)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> self.assertRaises(Exception):
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Bob Fox&#34;</span>, 2750))
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, date) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Alan Rock&#34;</span>, datetime.date(2024, 12, 20)))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;SELECT name, salary FROM employee&#34;</span>)
</span></span><span style=display:flex><span>            db_data = cur.fetchall()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    self.assertEqual(len(db_data), 1)
</span></span><span style=display:flex><span>    self.assertEqual(db_data[0], (<span style=color:#a31515>&#34;Dep Tunner&#34;</span>, 3000))
</span></span></code></pre></div><p>No teste de consistência acima, vemos 3 transações para inserir funcionários:</p><ul><li>A primeira tem uma operação para inserir o funcionário Dep Tunner;</li><li>Na segunda tem uma operação para inserir a funcionária Mary Castle, porém no campo do salário dessa funcionária passa se uma data invés de um número;</li><li>Por fim, a terceira operação tem uma transação para inserir o funcionário Bob Fox e o funcionário Alan Rock que tenta inserir em um campo chamado date uma data.</li></ul><p>Em resumo, apenas o funcionário Dep Tunner foi inserido porque a segunda transação foi revertida devido a um tipo de dado incorreto no campo salário, o que causou o rollback da transação. Da mesma forma, a terceira transação falhou ao tentar inserir dados em um campo que não existe na tabela. Esses mecanismos garantem a consistência dos dados ao impedir a inserção de tipos de dados incompatíveis ou a inserção em campos inexistentes na base de dados.</p><p>Devido à garantia de integridade, nossa tabela pode se tornar menos flexível, e restrições excessivas podem afetar a performance. Lembre-se de que todas as regras de integridade são aplicadas a cada operação. Portanto, é crucial escolher as regras com cuidado e, se necessário, medir o impacto delas no desempenho do sistema.</p><p>O I de Isolation(Isolamento) é a propriedade que gerencia a concorrência entre as transações. Cada transação opera independente das outras que estão rodando em paralelo, como se executasse um de cada vez. Há níveis de isolamento entre as transações que podem ser ativadas.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> test_isolation(self):
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Jess Tex&#34;</span>, 4000))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> transaction1():
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;SELECT id, salary FROM employee WHERE name = </span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (<span style=color:#a31515>&#34;Jess Tex&#34;</span>,))
</span></span><span style=display:flex><span>                db_data = cur.fetchone()
</span></span><span style=display:flex><span>                time.sleep(4)
</span></span><span style=display:flex><span>                new_salary = db_data[1] * 1.1
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;UPDATE employee SET salary=</span><span style=color:#a31515>%s</span><span style=color:#a31515> WHERE id=</span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (new_salary, db_data[0]))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> transaction2():
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                time.sleep(2)
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;SELECT id, salary FROM employee WHERE name = </span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (<span style=color:#a31515>&#34;Jess Tex&#34;</span>,))
</span></span><span style=display:flex><span>                db_data = cur.fetchone()
</span></span><span style=display:flex><span>                new_salary = db_data[1] * 1.2
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;UPDATE employee SET salary=</span><span style=color:#a31515>%s</span><span style=color:#a31515> WHERE id=</span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (new_salary, db_data[0]))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    threads = [Thread(target=transaction1), Thread(target=transaction2)]
</span></span><span style=display:flex><span>    <span style=color:#00f>for</span> thread <span style=color:#00f>in</span> threads:
</span></span><span style=display:flex><span>        thread.start()
</span></span><span style=display:flex><span>    <span style=color:#00f>for</span> thread <span style=color:#00f>in</span> threads:
</span></span><span style=display:flex><span>        thread.join()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;SELECT salary FROM employee WHERE name = </span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (<span style=color:#a31515>&#34;Jess Tex&#34;</span>,))
</span></span><span style=display:flex><span>                db_data = cur.fetchone()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    self.assertEqual(db_data[0], 4400)
</span></span></code></pre></div><p>O teste começa com a inserção da funcionária Jess Tex, e possui dois métodos que rodam em threads diferentes para uma concorrência de transações:</p><ul><li>O primeiro método seleciona a funcionária Jess, &ldquo;pensa&rdquo; por um tempo por 4 segundos e resolve realizar um aumento de 10% em seu salário.</li><li>No segundo método começa &ldquo;pensando&rdquo; por 2 segundos o que irá fazer, já seleciona a funcionária Jess e aplica um aumento de 20% em seu salário.</li></ul><p>No entanto, ao verificar, notamos que o salário da funcionária foi aumentado em apenas 10%, e não em 20% como esperado. O que aconteceu? A primeira transação não incorporou as alterações da segunda transação e acabou sobrescrevendo-as, resultando em uma inconsistência no banco de dados. Isso ocorreu porque as transações foram executadas de forma isolada, sem um tratamento adequado para garantir que as alterações de uma não interferissem na outra.</p><p>Existem diversas abordagens e configurações para controlar o isolamento de transações, e é melhor explorar esses detalhes em um <a href=../../posts/o-tal-do-isolamento/>próximo post</a>. No entanto, é importante notar que, ao acessar e escrever as mesmas informações, devemos prestar atenção ao nível de isolamento para equilibrar a consistência com a concorrência. Isso garantirá que as transações sejam tratadas da melhor maneira possível, considerando tanto a integridade dos dados quanto a eficiência do sistema.</p><p>O D de Durability(Durabilidade) é a propriedade que gerencia a recuperação do banco de dados em caso de falhas. Em caso de sucesso de uma transação, manter o estado de forma permanente.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> test_durability(self):
</span></span><span style=display:flex><span>    container = self.postgres.get_wrapped_container()
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Paul Port&#34;</span>, 3000))
</span></span><span style=display:flex><span>            conn.commit()
</span></span><span style=display:flex><span>            container.stop()
</span></span><span style=display:flex><span>            container.wait()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> self.assertRaises(Exception) <span style=color:#00f>as</span> cm:
</span></span><span style=display:flex><span>        psycopg.connect(self.connection_uri())
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    container.start()
</span></span><span style=display:flex><span>    self.postgres._connect()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;SELECT name, salary FROM employee&#34;</span>)
</span></span><span style=display:flex><span>            db_data = cur.fetchall()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    self.assertEqual(len(db_data), 1)
</span></span><span style=display:flex><span>    self.assertEqual(db_data[0], (<span style=color:#a31515>&#34;Paul Port&#34;</span>, 3000))
</span></span></code></pre></div><p>Podemos observar que, na primeira conexão aberta, após o comando para inserir um novo funcionário, forcei um commit e, em seguida, derrubei o container. Para demonstrar que o banco de dados estava inacessível, tentei acessá-lo e não obtive sucesso. Em seguida, iniciei novamente o banco de dados para verificar se os dados realmente foram salvos após o desligamento forçado do container. Dessa forma, conseguimos validar a propriedade de durabilidade.</p><p>Após uma transação ser confirmada por meio de um commit, todas as operações devem ser refletidas no banco de dados. A durabilidade garante que essas alterações sejam armazenadas em uma unidade de persistência não volátil. Assim, mesmo que o banco de dados sofra uma falha, as alterações realizadas durante a transação não serão perdidas.</p><p>Abordei todos os conceitos do ACID e deixei um gancho para discutir o isolamento com mais detalhes em outro post. O código apresentado foi criado para fins didáticos; em um ambiente real, você geralmente possui um conjunto de conexões abertas com o banco de dados e solicita conexões conforme necessário para as transações, ao contrário dos testes onde abri e fechei diversas conexões.</p><p>Espero que tenha aproveitado a jornada! Se quiser explorar novas abordagens para entender o ACID, confira os três links que seguem. Até mais!</p><p>Referências:</p><p><a href=https://www.freecodecamp.org/news/acid-databases-explained/>ACID Databases – Atomicity, Consistency, Isolation & Durability Explained</a></p><p><a href=https://medium.com/@mesfandiari77/acid-properties-dc233074050c>ACID Properties</a></p><p><a href=https://brandur.org/acid>Building Robust Systems with ACID and Constraints</a></p></div><div class=tags></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="alenvieira",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div class="footer wrapper"><nav class=nav><div>Exceto onde indicado de outra forma, todos os conteúdos neste site essão licenciados sob licença <a class=subfoot href=https://creativecommons.org/licenses/by/4.0/ rel=license>Creative Commons Atribuição 4.0 Internacional</a></div><div>Desenvolvido com <a href=https://gohugo.io>Hugo</a>, adaptando o tema <a href=https://github.com/knadh/hugo-ink>Ink</a></div></nav></div><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-123-45","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></body></html>