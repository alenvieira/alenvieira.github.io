<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Explicando o A.C.I.D. com testes - Alen Vieira</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta itemprop=name content="Explicando o A.C.I.D. com testes"><meta itemprop=description content="Quais são as garantias do A.C.I.D.?"><meta itemprop=datePublished content="2024-04-15T12:18:29-03:00"><meta itemprop=dateModified content="2024-04-15T12:18:29-03:00"><meta itemprop=wordCount content="1752"><meta itemprop=keywords content><meta property="og:title" content="Explicando o A.C.I.D. com testes"><meta property="og:description" content="Quais são as garantias do A.C.I.D.?"><meta property="og:type" content="article"><meta property="og:url" content="https://alenvieira.github.io/posts/explicando-acid/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-15T12:18:29-03:00"><meta property="article:modified_time" content="2024-04-15T12:18:29-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Explicando o A.C.I.D. com testes"><meta name=twitter:description content="Quais são as garantias do A.C.I.D.?"><link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=https://alenvieira.github.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://alenvieira.github.io/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=https://alenvieira.github.io/css/dark.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://alenvieira.github.io/js/main.js></script></head><body><div class="container wrapper"><div class=header><h1 class=site-title><a href=https://alenvieira.github.io/>Alen Vieira</a></h1><div class=site-description><p>Compartilhando ou documentando questões</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/alenvieira title=Github><i data-feather=github></i></a></li><li><a href=https://twitter.com/alen_vieira title=Twitter><i data-feather=twitter></i></a></li><li><a href=../../index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=../../>Home</a></li><li><a href=../../posts>Posts</a></li><li><a href=../../about>Sobre</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>15</span>
<span class=rest>Apr 2024</span></div></div><div class=matter><h1 class=title>Explicando o A.C.I.D. com testes</h1></div></div><div class=markdown><blockquote><p>Os dados são preciosos e duram mais que os próprios sistemas. Tim Berners-Lee</p></blockquote><p>O A.C.I.D. é uma sopa de letrinhas que oferece diversas garantias para transações em diferentes bancos de dados. Certo, mas que história é essa de explicar isso com testes? Essas propriedades são difundidas na forma teórica, porém nem sempre vemos na prática por meio de código. Gosto de ver como um conceito funciona por meio do código, mais especificamente com testes unitários e assim consigo assimilar melhor os conceitos.</p><p>Os testes usaram a linguagem de programação <a href=https://www.python.org/>Python</a>, <a href=https://www.postgresql.org/>PostgreSQL</a> como banco de dados relacional, usamos a biblioteca Python <a href=https://testcontainers-python.readthedocs.io/en/latest/>testcontainers-python</a> para rodar o PostgreSQL em um container e a biblioteca Python <a href=https://www.psycopg.org/psycopg3/>Psycopg 3</a> para conectar-se ao PostgreSQL e executar comandos. Mais informações podem ser encontradas neste <a href=https://github.com/alenvieira/acidwithtests/>repositório</a> no qual até <a href=https://github.com/alenvieira/acidwithtests/actions/runs/8672804316/job/23783502175>rodei os testes</a> através do Github Actions e provar que não rodam somente na minha máquina :D.</p><p>Um detalhe muito importante ao qual prestar atenção é o uso de contexto de conexão. As conexões criadas usando with no Psycopg 3 apresentam o seguinte comportamento:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green># Fonte: https://www.psycopg.org/psycopg3/docs/basic/usage.html#connection-context</span>
</span></span><span style=display:flex><span>conn = psycopg.connect()
</span></span><span style=display:flex><span><span style=color:#00f>try</span>:
</span></span><span style=display:flex><span>    ... <span style=color:green># use the connection</span>
</span></span><span style=display:flex><span><span style=color:#00f>except</span> BaseException:
</span></span><span style=display:flex><span>    conn.rollback()
</span></span><span style=display:flex><span><span style=color:#00f>else</span>:
</span></span><span style=display:flex><span>    conn.commit()
</span></span><span style=display:flex><span><span style=color:#00f>finally</span>:
</span></span><span style=display:flex><span>    conn.close()
</span></span></code></pre></div><p>Ou seja, se tudo for concluído com sucesso durante a conexão, todas as operações serão confirmadas(commit), caso contrário tudo será revertido(rollback) e em ambos os casos a conexão será encerrada.</p><p>Para preparar o ambiente dos testes unitários, precisei criar o seguinte:</p><ul><li>o método setUpClass que inicia o PostgreSQL e cria uma tabela nele na criação da classe, ou seja, antes de executar os testes;</li><li>o método tearDownClass para parar o PostgreSQL após todos os testes;</li><li>o método connection_uri permite obter facilmente um URI do Postgresql e usá-lo para criar uma conexão;</li><li>o método tearDown para fazer a limpeza na tabela após cada teste.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>class</span> <span style=color:#2b91af>AcidWithPostgresTestCase</span>(unittest.TestCase):
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> setUpClass(cls):
</span></span><span style=display:flex><span>        cls.postgres = PostgresContainer(<span style=color:#a31515>&#34;postgres:16.2-alpine&#34;</span>)
</span></span><span style=display:flex><span>        cls.postgres.start()
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(cls.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;CREATE TABLE employee (id serial PRIMARY KEY, name text, salary double precision)&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> tearDownClass(cls):
</span></span><span style=display:flex><span>        cls.postgres.stop()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> connection_uri(cls):
</span></span><span style=display:flex><span>        <span style=color:#00f>return</span> cls.postgres.get_connection_url().replace(<span style=color:#a31515>&#34;+psycopg2&#34;</span>, <span style=color:#a31515>&#34;&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> tearDown(self):
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;DELETE FROM employee&#34;</span>)
</span></span></code></pre></div><p>Todos os conceitos apresentados são sobre transações. Mas o que é uma transação? Transação é um processo que envolve uma ou mais operações de leitura e gravação e está normalmente associada a uma regra de negócio. Ok! Vamos aos testes de cada letrinha do acrônimo:</p><p>O A de Atomicity(Atomicidade) é a propriedade responsável por gerenciar as transações. As transações são indivisíveis/atômicas, devem confirmar tudo com um commit ou desfazer tudo com um rollback.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> test_atomicity(self):
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;John Smith&#34;</span>, 2500))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> self.assertRaises(Exception):
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Beth Lee&#34;</span>, 3500))
</span></span><span style=display:flex><span>                <span style=color:#00f>raise</span> RuntimeError
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;SELECT name, salary FROM employee&#34;</span>)
</span></span><span style=display:flex><span>            db_data = cur.fetchall()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    self.assertEqual(len(db_data), 1)
</span></span><span style=display:flex><span>    self.assertEqual(db_data[0], (<span style=color:#a31515>&#34;John Smith&#34;</span>, 2500))
</span></span></code></pre></div><p>No teste de atomicidade acima, a primeira parte mostra uma transação adicionando o funcionário John Smith e a segunda parte mostra uma transação adicionando a funcionária Beth Lee, mas imediatamente após ocorre uma exceção. Que poderia ser inúmeras situações como, por exemplo, o tipo do dado do salário errado, ou uma regra de negócio incorreta. Neste exemplo, simplifiquei retornando uma exceção RuntimeError. A terceira parte verifica quais funcionários estão salvos.</p><p>Na parte final, há uma primeira asserção que realmente foi salvo apenas um registro no banco. Pode ser confuso. Ué porque só um? Então, vamos por partes, a primeira parte foi salvo o John com sucesso totalizando um registro. Na segunda parte, apesar da operação de salvar a Beth estava certinha, logo depois ocorre uma exceção que faz todas as operações da transação serem revertidas. E assim, finaliza os testes checando se foi o John que realmente foi salvo, concluindo que as transações são realmente indivisíveis e evitando transações que possam introduzir dados inconsistentes.</p><p>Porém, entretanto, todavia, é preciso tomar cuidado com o que realmente as operações que realmente necessitam estarem juntas numa transação, por exemplo, uma transferência de valores, uma transação de X para Y, vai alterar valores de X e Y então é um caso bem interessante de estarem juntas. Já o caso de inserir funcionários no sistema podem não serem o melhor exemplo, visto que cada cadastro de funcionário pode ser independente. Faça a análise de seu cenário!</p><p>O C de Consistency(Consistência) é uma propriedade associada às regras de integridade definidas. Cada transação sempre deixa o estado consistente. Isso significa que todas as regras de integridade são aplicadas como validações de existência da coluna, de tipo de dado da coluna, de chave primária, de chave estrangeira, de unicidade da coluna e outras restrições que o banco de dados suporte.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> test_consistency(self):
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Dep Tunner&#34;</span>, 3000))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> self.assertRaises(Exception):
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Mary Castle&#34;</span>, datetime.date(2024, 12, 20)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> self.assertRaises(Exception):
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Bob Fox&#34;</span>, 2750))
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, date) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Alan Rock&#34;</span>, datetime.date(2024, 12, 20)))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;SELECT name, salary FROM employee&#34;</span>)
</span></span><span style=display:flex><span>            db_data = cur.fetchall()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    self.assertEqual(len(db_data), 1)
</span></span><span style=display:flex><span>    self.assertEqual(db_data[0], (<span style=color:#a31515>&#34;Dep Tunner&#34;</span>, 3000))
</span></span></code></pre></div><p>No teste de consistência acima, vemos 3 transações para inserir funcionários:</p><ul><li>A primeira tem uma operação para inserir o funcionário Dep Tunner;</li><li>Na segunda tem uma operação para inserir a funcionária Mary Castle, porém no campo do salário dessa funcionária passa se uma data invés de um número;</li><li>Por fim, a terceira operação tem uma transação para inserir o funcionário Bob Fox e o funcionário Alan Rock que tenta inserir em um campo chamado date uma data.</li></ul><p>Em resumo, só o funcionário Dep Tunner foi inserido porque a segunda foi revertida porque o tipo de dado do campo salário foi passado incorretamente revertendo a transação, assim como na terceira transação que tenta inserir em um campo que não existe na tabela. Isso garante a consistência dos dados ao não permitir tipo de dados diferente ao mapeado ou campo não existente na base de dados.</p><p>Por conta dessa garantia, nossa tabela é menos flexível e restrições demais podem afetar nossa performance. Lembre-se, todas as regras de integridade são aplicadas a cada operação. Escolha bem suas regras e faça uma medição do impacto dela se necessário.</p><p>O I de Isolation(Isolamento) é a propriedade que gerencia a concorrência entre as transações. Cada transação opera independente das outras que estão rodando em paralelo, como se executasse um de cada vez. Há níveis de isolamento entre as transações que podem ser ativadas.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> test_isolation(self):
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Jess Tex&#34;</span>, 4000))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> transaction1():
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;SELECT id, salary FROM employee WHERE name = </span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (<span style=color:#a31515>&#34;Jess Tex&#34;</span>,))
</span></span><span style=display:flex><span>                db_data = cur.fetchone()
</span></span><span style=display:flex><span>                time.sleep(4)
</span></span><span style=display:flex><span>                new_salary = db_data[1] * 1.1
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;UPDATE employee SET salary=</span><span style=color:#a31515>%s</span><span style=color:#a31515> WHERE id=</span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (new_salary, db_data[0]))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>def</span> transaction2():
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                time.sleep(2)
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;SELECT id, salary FROM employee WHERE name = </span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (<span style=color:#a31515>&#34;Jess Tex&#34;</span>,))
</span></span><span style=display:flex><span>                db_data = cur.fetchone()
</span></span><span style=display:flex><span>                new_salary = db_data[1] * 1.2
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;UPDATE employee SET salary=</span><span style=color:#a31515>%s</span><span style=color:#a31515> WHERE id=</span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (new_salary, db_data[0]))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    threads = [Thread(target=transaction1), Thread(target=transaction2)]
</span></span><span style=display:flex><span>    <span style=color:#00f>for</span> thread <span style=color:#00f>in</span> threads:
</span></span><span style=display:flex><span>        thread.start()
</span></span><span style=display:flex><span>    <span style=color:#00f>for</span> thread <span style=color:#00f>in</span> threads:
</span></span><span style=display:flex><span>        thread.join()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>            <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>                cur.execute(<span style=color:#a31515>&#34;SELECT salary FROM employee WHERE name = </span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span>, (<span style=color:#a31515>&#34;Jess Tex&#34;</span>,))
</span></span><span style=display:flex><span>                db_data = cur.fetchone()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    self.assertEqual(db_data[0], 4400)
</span></span></code></pre></div><p>O teste começa com a inserção da funcionária Jess Tex, e possui dois métodos que rodam em threads diferentes para uma concorrência de transações:</p><ul><li>O primeiro método seleciona a funcionária Jess, &ldquo;pensa&rdquo; por um tempo por 4 segundos e resolve realizar um aumento de 10% em seu salário.</li><li>No segundo método começa &ldquo;pensando&rdquo; por 2 segundos o que irá fazer, já seleciona a funcionária Jess e aplica um aumento de 20% em seu salário.</li></ul><p>Porém, quando fazemos a verificação, a funcionária tem apenas o aumento de 10% em seu salário. O que ocorreu? E o aumento de 20% da segunda transação? Ocorreu que a primeira transação não obteve as alterações da segunda transação e sobrescreve, causando uma inconsistência no banco de dados. As transações ocorreram de forma isolada e não houve um devido tratamento para a situação.</p><p>Há diversas maneiras de tratar a situação e diferentes configurações para um melhor controle do isolamento, na qual é melhor tratar em um próximo post sobre isso. Em todo caso, nos casos de acesso e escrita de mesma informações temos que nos atentar ao isolamento e assim obter a melhor situação entre obter o melhor tratamento com a consistência ou com a concorrência.</p><p>O D de Durability(Durabilidade) é a propriedade que gerencia a recuperação do banco de dados em caso de falhas. Em caso de sucesso de uma transação, manter o estado de forma permanente.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00f>def</span> test_durability(self):
</span></span><span style=display:flex><span>    container = self.postgres.get_wrapped_container()
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;INSERT INTO employee (name, salary) VALUES (</span><span style=color:#a31515>%s</span><span style=color:#a31515>, </span><span style=color:#a31515>%s</span><span style=color:#a31515>)&#34;</span>, (<span style=color:#a31515>&#34;Paul Port&#34;</span>, 3000))
</span></span><span style=display:flex><span>            conn.commit()
</span></span><span style=display:flex><span>            container.stop()
</span></span><span style=display:flex><span>            container.wait()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> self.assertRaises(Exception) <span style=color:#00f>as</span> cm:
</span></span><span style=display:flex><span>        psycopg.connect(self.connection_uri())
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    container.start()
</span></span><span style=display:flex><span>    self.postgres._connect()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>with</span> psycopg.connect(self.connection_uri()) <span style=color:#00f>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#00f>with</span> conn.cursor() <span style=color:#00f>as</span> cur:
</span></span><span style=display:flex><span>            cur.execute(<span style=color:#a31515>&#34;SELECT name, salary FROM employee&#34;</span>)
</span></span><span style=display:flex><span>            db_data = cur.fetchall()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    self.assertEqual(len(db_data), 1)
</span></span><span style=display:flex><span>    self.assertEqual(db_data[0], (<span style=color:#a31515>&#34;Paul Port&#34;</span>, 3000))
</span></span></code></pre></div><p>Podemos ver que na primeira conexão aberta logo após o comando de inserir um novo funcionário já forcei um commit e então derrubei o container. Para provar que o banco de dados está inacessível, tentar acessar e não conseguir. Então já começa os procedimentos para inicializar o banco de dados novamente para consultar se os dados realmente foram salvos após desligar forçadamente o container. Assim verificamos esta propriedade.</p><p>Então, após a transação ser confirmada por meio de um commit as operações devem refletir no banco de dados. A durabilidade entra em jogo garantindo que tudo seja armazenado em uma unidade de persistência não volátil e mesmo se o banco de dados falhar nada será perdido.</p><p>Abordei todos os conceitos do ACID e deixei um gancho para discutir o isolamento com mais detalhes em outro post. O código foi criado para fins didáticos. Em circunstâncias normais, você tem um conjunto de conexões com o banco de dados abertas e vai solicitando conexões para as transações, diferentemente dos testes em que abri e fechei diversas conexões. Espero que tenha aproveitado a jornada e se quiser novas abordagens explicando o ACID logo mais tem três links. Até!</p><p>Referências:</p><p><a href=https://www.freecodecamp.org/news/acid-databases-explained/>ACID Databases – Atomicity, Consistency, Isolation & Durability Explained</a></p><p><a href=https://medium.com/@mesfandiari77/acid-properties-dc233074050c>ACID Properties</a></p><p><a href=https://brandur.org/acid>Building Robust Systems with ACID and Constraints</a></p></div><div class=tags></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="alenvieira",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div class="footer wrapper"><nav class=nav><div>Exceto onde indicado de outra forma, todos os conteúdos neste site essão licenciados sob licença <a class=subfoot href=https://creativecommons.org/licenses/by/4.0/ rel=license>Creative Commons Atribuição 4.0 Internacional</a></div><div>Desenvolvido com <a href=https://gohugo.io>Hugo</a>, adaptando o tema <a href=https://github.com/knadh/hugo-ink>Ink</a></div></nav></div><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-123-45","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></body></html>